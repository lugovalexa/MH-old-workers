---
title: "Models"
output: html_notebook
---

### Load libraries

```{r}
library(plm)
library(lmtest)
library(dplyr)
library(crosstable)
```

### Load data
```{r}
data <- read.csv("/Users/alexandralugova/Documents/GitHub/MH-old-workers/data/datasets/results/4digits_w46_year_balanced.csv")
```

### Create some additional variables
```{r}
# Explanatory variables
# age squared
data$age_squared <- data$age^2
# income log
data$thinc_log <- log(data$thinc + 1)
data$thinc2_log <- log(data$thinc2 + 1)
# work horizon change binary
data$work_horizon_change_bin0 <- ifelse(data$work_horizon_change > 0, 1, 0)
data$work_horizon_change_bin1 <- ifelse(data$work_horizon_change > 1, 1, 0)
# work horizon change categorical
data$work_horizon_change_cat <- cut(data$work_horizon_change, breaks = c(-Inf, 0, 1, 2, Inf), labels = c("0", "<1", "<2", "2+"), include.lowest = TRUE)

# DID variables
# post treatment period
data$time = ifelse(data$year >= 2015, 1, 0)
# treatment group if work_horizon_change > 0
mergeids_to_treat <- data %>%
  filter(time == 1 & work_horizon_change > 0) %>%
  select(mergeid) %>%
  distinct()
data <- data %>%
  mutate(treated = ifelse(mergeid %in% mergeids_to_treat$mergeid, 1, 0))
# did
data$did = data$time * data$treated
```

### Descriptive statistics
```{r}
# demographics
data_summary <- data %>% dplyr::select(gender, age, nb_children, nb_grandchildren, partnerinhh, yrseducation, thinc, investment, life_insurance)
knitr::kable(psych::describe(data_summary, skew = FALSE), digits = c(1,4,2,2,1,1,1,3))
```

```{r}
# work
data_summary <- data %>% dplyr::select(yrscontribution, retirement_age, work_horizon, work_horizon_change, jqi_skills_discretion, jqi_physical_environment, jqi_social_environment, jqi_working_time_quality, jqi_prospects, jqi_intensity, jqi_sum)
knitr::kable(psych::describe(data_summary, skew = FALSE), digits = c(1,4,2,2,1,1,1,3))
```

```{r}
# health
data_summary <- data %>% dplyr::select(sphus, sphus2, chronic, chronic2, eurod, eurodcat, affective_suffering, motivation_lack)
knitr::kable(psych::describe(data_summary, skew = FALSE), digits = c(1,4,2,2,1,1,1,3))
```

### Cross table and different tests
```{r}
# demographics
crosstable(data, c(gender, age, nb_children, nb_grandchildren, partnerinhh, yrseducation, thinc, investment, life_insurance), by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```

```{r}
# work
crosstable(data, c(yrscontribution, retirement_age, work_horizon, work_horizon_change, work_horizon_change_bin0, work_horizon_change_bin1, work_horizon_change_cat, job_status, industry, jqi_skills_discretion, jqi_physical_environment, jqi_social_environment, jqi_working_time_quality, jqi_prospects, jqi_intensity, jqi_sum), by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```

```{r}
# health
crosstable(data, c(sphus, sphus2, chronic, chronic2), by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```

### Models - fixed vs random effects
Linear model
```{r}
l_mod <- lm(eurod ~ work_horizon_change + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted + jqi_prospects_weighted + jqi_intensity_weighted + factor(industry) + factor(country),
               data = data, weights = my_wgt)
summary(l_mod)
```

Fixed effects
```{r}
fe_mod <- plm(eurod ~ factor(work_horizon_change_cat) + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted + jqi_prospects_weighted + jqi_intensity_weighted + factor(industry) + factor(country),
               data = data,
               index = c("mergeid","year"),
               model = "within",
               weights = my_wgt)
summary(fe_mod)
```

```{r}
pFtest(fe_mod, l_mod) # pFtest -> fixed effects better as p-value is small
```

```{r}
plmtest(fe_mod, c("time"), type=("bp")) # -> Lagrange Multiplier Test for time effects (Breush-Pagan) -> do not need time-fixed effects as p-value is large
```

Two-way fixed effects
```{r}
model <- plm(eurod ~ work_horizon + factor(work_horizon_change_cat) + age +
    I(age_squared) + gender + nb_children + nb_grandchildren +
    partnerinhh + yrseducation + thinc + thinc_log + investment +
    life_insurance + sphus + chronic + jqi_skills_discretion_weighted +
    jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted +
    jqi_prospects_weighted + jqi_intensity_weighted + factor(industry) + factor(country),
             data = pdata,
             model = "within",  # Fixed-effects model
             effect = "twoways",  # Include both individual and country fixed effects
             index = c("mergeid", "isco", "year"), weights=my_wgt)
summary(model)
```



Random effects
```{r}
re_mod <- plm(eurod ~ work_horizon_change + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted + jqi_prospects_weighted + jqi_intensity_weighted + factor(industry) + factor(country),
               data = data,
               index = c("mergeid", "year"),
               model = "random", weights = my_wgt)
summary(re_mod)
```

```{r}
phtest(fe_mod,re_mod) # Hausman test -> random effects better as p-value is large
```

Work horizon change cat
```{r}
re_mod <- plm(eurod ~ factor(work_horizon_change_cat) + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted + jqi_prospects_weighted + jqi_intensity_weighted + factor(country) + factor(industry),
               data = data,
               index = c("mergeid", "year"),
               model = "random",
               weights = my_wgt)
summary(re_mod)
```

Work horizon change bin0
```{r}
re_mod <- plm(eurod ~ work_horizon_change_bin0 + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted + jqi_prospects_weighted + jqi_intensity_weighted + factor(country) + factor(industry),
               data = data,
               index = c("mergeid", "year"),
               model = "random",
               weights = my_wgt)
summary(re_mod)
```

Work horizon change bin0 Logit
```{r}
re_mod <- plm(eurodcat ~ factor(work_horizon_change_cat) + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted + jqi_prospects_weighted + jqi_intensity_weighted + factor(country) + factor(industry),
               data = data,
               index = c("mergeid", "year"),
               model = "random",
               family = binomial(link = "logit"),
               weights = my_wgt)
summary(re_mod)
```


# DID
```{r}
fe_mod <- plm(eurod ~ treated + time + did + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted + jqi_social_environment_weighted + jqi_working_time_quality_weighted + jqi_prospects_weighted + jqi_intensity_weighted + factor(country) + factor(industry) + factor(isco),
               data = data,
               index = c("mergeid", "year"),
               model = "within",
               weights = my_wgt)
summary(fe_mod)
```


### DID

```{r}
didreg = lm(eurod ~ treated + time + did, data = data, weights=my_wgt)
summary(didreg)
```

DID with explanatory variables

```{r}
didreg = lm(eurod ~ treated + time + did + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted + jqi_physical_environment_weighted  + jqi_social_environment_weighted  + jqi_working_time_quality_weighted  + jqi_prospects_weighted  + jqi_intensity_weighted  + factor(industry) + factor(country), data = data, weights=my_wgt)
summary(didreg)
```

DID with explanatory variables EuroD binary

```{r}
logit_reg <- glm(eurodcat ~ treated + time + did + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted  + jqi_physical_environment_weighted  + jqi_social_environment_weighted  + jqi_working_time_quality_weighted  + jqi_prospects_weighted  + jqi_intensity_weighted  + factor(industry) + factor(country), data = data,
                 family = binomial(link = "logit"), weights = my_wgt)
summary(logit_reg)
```


```{r}
subset_data <- subset(pdata, gender == 1)
mean_physical_environment <- mean(subset_data$jqi_physical_environment)
filtered_data <- subset_data[subset_data$jqi_physical_environment < mean_physical_environment, ]

didreg <- plm(eurod ~ treated + time + did + age + I(age_squared) + gender + nb_children + nb_grandchildren + partnerinhh + yrseducation + thinc + thinc_log + investment + life_insurance + sphus + chronic + work_horizon + jqi_skills_discretion_weighted  + jqi_physical_environment_weighted  + jqi_social_environment_weighted  + jqi_working_time_quality_weighted  + jqi_prospects_weighted  + jqi_intensity_weighted + factor(country) + factor(industry),
              data = filtered_data, model = "within", effect = "individual", weights = my_wgt)

# Display summary
summary(didreg)
```


# DID for physcial environment above mean

```{r}
mean_physical_environment <- mean(data$jqi_physical_environment)
filtered_data <- data[data$jqi_physical_environment > mean_physical_environment, ]

didreg = lm(eurod ~ treated + time + did + age + I(age_squared) + gender + nb_children + partnerinhh + yrseducation + work_horizon + jqi_monthly_earnings + jqi_skills_discretion + jqi_social_environment + jqi_intensity + jqi_prospects + jqi_working_time_quality, data = filtered_data)
summary(didreg)
```
