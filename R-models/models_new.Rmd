---
title: "Models"
output: html_notebook
---

### Load libraries

```{r}
library(plm)
library(lmtest)
library(dplyr)
library(crosstable)
library(did)
library(car)
library(corrplot)
library(ggplot2)
library(glmnet)
library(MASS)
library(texreg)
library(sandwich)
```

### Load data
```{r}
data <- read.csv("/Users/alexandralugova/Documents/GitHub/MH-old-workers/data/datasets/results/4digits_w46_year_balanced.csv")
```

### Create some additional variables
```{r}
# Explanatory variables
# age squared
data$age_squared <- data$age^2
# income log
data$thinc_log <- log(data$thinc + 1)
data$thinc2_log <- log(data$thinc2 + 1)
# children and grandchildren together

# work horizon change binary
data$work_horizon_change_bin0 <- ifelse(data$work_horizon_change_total > 0, 1, 0)
data$work_horizon_change_bin1 <- ifelse(data$work_horizon_change_total > 1, 1, 0)
# work horizon change categorical
data$work_horizon_change_cat <- cut(data$work_horizon_change_total, breaks = c(-Inf, 0, 1, 2, Inf), labels = c("0", "<1", "<2", "2+"), include.lowest = TRUE)

# DID variables
# post treatment period
data$time = ifelse(data$year >= 2015, 1, 0)
# treatment group if work_horizon_change > 0
mergeids_to_treat <- data %>%
  filter(time == 1 & work_horizon_change_total > 0) %>%
  distinct(mergeid)
data <- data %>%
  mutate(treated = ifelse(mergeid %in% mergeids_to_treat$mergeid, 1, 0))
# did
data$did = data$time * data$treated

# Remove individuals with extreme eurod values
rows_to_remove <- data %>%
  filter(eurod == 12) %>%
  distinct(mergeid)
data <- data %>%
  filter(!mergeid %in% rows_to_remove$mergeid)

# Determine cell fol fixed effects/ cluster standard errors
data$cell <- paste(data$country, data$gender, data$isco, sep = "_")
data2015 <- data %>%
  filter(time == 1) %>%
  dplyr::select(mergeid, country, work_horizon_change_total)
data2015$cell1 <- paste(data2015$country, data2015$work_horizon_change_total, sep = "_")
data <- data %>%
 left_join(data2015 %>% dplyr::select(mergeid,cell1), by = "mergeid")
cells_to_remove <- data %>%
 group_by(cell1) %>%
 summarise(count = n(), .groups = 'drop') %>%
 filter(count < 4) %>% pull(cell1)
data <- data %>% filter(!(cell1 %in% cells_to_remove))

# Interactions of indexes
interaction_terms <- model.matrix(~ (jqi_skills_discretion + jqi_physical_environment +
  jqi_social_environment + jqi_working_time_quality +
  jqi_prospects + jqi_intensity)^2, data = data)

interaction_terms <- interaction_terms[, -c(1, 2, 3, 4, 5, 6, 7)]
interaction_terms_colnames <- colnames(interaction_terms)

data <- cbind(data, interaction_terms)

# For YTR between 0 and 1 only
#sum_by_mergeid <- data %>% group_by(mergeid) %>% summarize(total_work_horizon_change = sum(work_horizon_change, na.rm = TRUE))
#mergeid_to_remove <- sum_by_mergeid %>% filter(total_work_horizon_change > 1) %>% pull(mergeid)
#data <- data %>% filter(!(mergeid %in% mergeid_to_remove))
```

Number of treated individuals
```{r}
sum(data$did)
```

# DID models
```{r}
# Calculate the difference in means between treatment and control in the POST-treatment period
post_difference <- mean(data$eurod[data$treated == 1 & data$year == 2015]) -
   mean(data$eurod[data$treated == 0 & data$year == 2015])
post_difference
```

```{r}
# Calculate the difference in means between treatment and control in the PRE-treatment period
pre_difference <- mean(data$eurod[data$treated == 1 & data$year == 2011]) -
   mean(data$eurod[data$treated == 0 & data$year == 2011])
pre_difference
```

```{r}
# Calculate the difference-in-differences
diff_in_diff <- post_difference - pre_difference
diff_in_diff
```

```{r}
library(pscl)

model_negbinom <- zeroinfl(eurod ~ did + time + partnerinhh + nb_children + nb_grandchildren + yrseducation + sphus + chronic
               + life_insurance + investment + thinc2_log + work_horizon + jqi_sum + factor(cell1), data = subset(data, gender==1),
               dist = "negbin", link = "logit", weights=my_wgt)
```

```{r}
mod <- glm(eurodcat ~ age #+ time + partnerinhh + nb_children + nb_grandchildren + yrseducation + sphus + chronic
               #+ life_insurance + investment + thinc2_log + work_horizon + jqi_sum + factor(cell1)
               ,data = subset(data, gender==1), weights=my_wgt, family="binomial")
summary(mod)
```


EuroD - count data with quasi-poisson distribution (quasi as overdisperion (variance gretaer then mean))

```{r}
# quasipoisson justification
set.seed(1234)
theoretic_count <-rpois(2340,1.96)

# theoretic distribution
tc_df <-data.frame(theoretic_count)

# comparison with effective values
library(ggplot2)
ggplot(dataf,aes(eurod))+
   geom_bar(fill="#1E90FF")+
   geom_bar(data=tc_df, aes(theoretic_count,fill="#1E90FF", alpha=0.5))+
   theme_classic()+
   theme(legend.position="none")
```

```{r}
fit1 <- glm(eurod ~  did,
                       data  = data, weights=my_wgt, family = "quasipoisson")
summary(fit1, vcov = vcovHC, type = "HC1")
```

```{r}
clustered_se <- vcovHC(fit1, type = "HC1", cluster = "cell1") # Cluster standard errors at the country level
robust_se <- sqrt(diag(clustered_se)) # Obtain robust standard errors

coeftest(fit1, vcov. = clustered_se)
```
```{r}
fit2 <- glm(eurodcat ~  time + did + as.factor(cell1),
                       data  = data,  weights=my_wgt, family = "binomial")
summary(fit2, vcov = vcovHC, type = "HC1")
```


```{r}
fit2 <- glm(eurod ~  time + did + as.factor(cell1),
                       data  = data,  weights=my_wgt, family = "quasipoisson")
summary(fit2, vcov = vcovHC, type = "HC1")
```

```{r}
clustered_se <- vcovHC(fit2, type = "HC1", cluster = "cell1") # Cluster standard errors at the country level
robust_se <- sqrt(diag(clustered_se)) # Obtain robust standard errors

coeftest(fit2, vcov. = clustered_se)
```

```{r}
fit3 <- glm(eurod ~ did + time + gender + partnerinhh + nb_children + nb_grandchildren + yrseducation + sphus + chronic
               + life_insurance + investment + thinc2_log + work_horizon + jqi_sum + as.factor(cell1) + as.factor(industry),
                       data=data, weights=my_wgt, family="quasipoisson")
summary(fit3, vcov = vcovHC, type = "HC1", clustered_se="cell1")
```

```{r}
clustered_se <- vcovHC(fit3, type = "HC1", cluster = "cell1") # Cluster standard errors at the country level
robust_se <- sqrt(diag(clustered_se)) # Obtain robust standard errors

coeftest(fit3, vcov. = clustered_se)
```

```{r}
fit4 <- glm(eurod ~ did + time+ partnerinhh + nb_children + nb_grandchildren + yrseducation + sphus + chronic
               + life_insurance + investment + thinc2_log + work_horizon + jqi_physical_environment + jqi_social_environment
               + jqi_intensity + jqi_prospects + jqi_working_time_quality + as.factor(cell1) + as.factor(industry),
                       data=subset(data,gender==1), weights=my_wgt, family="quasipoisson")

#summary(fe_mod2)$coefficients['work_horizon_change_total',]
summary(fit4, robust = "vcovHC")
```

```{r}
robust_se <- sandwich(fit4)

summary(fit4, robust = "vcovHC")
```


```{r}
clustered_se <- vcovHC(fit4, type = "HC1", cluster = "cell1") # Cluster standard errors at the country level
robust_se <- sqrt(diag(clustered_se)) # Obtain robust standard errors

coeftest(fit4, vcov. = clustered_se)
```

```{r}
drop_in_dev <- anova(fit3, fit4, test = "F")
print(drop_in_dev)
```

```{r}
anova(fit4, test = "F")
```

# Tests
```{r}
par(mfrow = c(2, 2))
plot(fit4)
```

Normality of residuals - DID approach is robust to this

Breusch-Pagan test for heteroscedasticity
```{r}
bptest(fit4) #small p-value - not normal - heteroscedasticity present
```

```{r}
# Multicollinearity VIF TEST
vif(fit4)
```

# Full list of models
```{r}
interaction_formula <- paste(interaction_terms_colnames, collapse = " + ")
full_formula <- reformulate(c("did", "time", "partnerinhh", "nb_children", "nb_grandchildren", "yrseducation", "sphus", "chronic",
               "life_insurance", "investment", "thinc2_log", "work_horizon", "jqi_physical_environment", "jqi_social_environment",
               "jqi_intensity", "jqi_prospects", "jqi_working_time_quality", "as.factor(cell1)", "as.factor(industry)"),response="eurod")
noind_formula <- reformulate(c("did", "time", "partnerinhh", "nb_children", "nb_grandchildren", "yrseducation", "sphus", "chronic",
               "life_insurance", "investment", "thinc2_log", "work_horizon", "jqi_sum", "as.factor(cell1)", "as.factor(industry)"),response="eurod")
```


```{r}
# DID full dataset panel fixed effects
did_full = glm(eurod ~ did + time + gender + partnerinhh + nb_children + nb_grandchildren + yrseducation + sphus + chronic
               + life_insurance + investment + thinc2_log + work_horizon + jqi_physical_environment + jqi_social_environment
               + jqi_intensity + jqi_prospects + jqi_working_time_quality + as.factor(cell1) + as.factor(industry),
               data = data, weights = my_wgt, family="quasipoisson")

# DID female/male
did_female = glm(full_formula, data = subset(data, gender == 1), weights = my_wgt, family="quasipoisson")
did_male = glm(full_formula, data = subset(data, gender == 0), weights = my_wgt, family="quasipoisson")

# DID female/male jqi_skills_discretion above/below mean
did_female_skills_high = glm(noind_formula, data = subset(data, gender == 1 & jqi_skills_discretion >= median(jqi_skills_discretion)), weights = my_wgt, family="quasipoisson")
did_female_skills_low= glm(noind_formula, data = subset(data, gender == 1 & jqi_skills_discretion < median(jqi_skills_discretion)), weights = my_wgt, family="quasipoisson")
did_male_skills_high = glm(noind_formula, data = subset(data, gender == 0 & jqi_skills_discretion >= median(jqi_skills_discretion)), weights = my_wgt, family="quasipoisson")
did_male_skills_low = glm(noind_formula, data = subset(data, gender == 0 & jqi_skills_discretion < median(jqi_skills_discretion)), weights = my_wgt, family="quasipoisson")

# DID female/male jqi_physical_environment above/below mean
did_female_physical_high = glm(noind_formula, data = subset(data, gender == 1 & jqi_physical_environment >= median(jqi_physical_environment)), weights = my_wgt, family="quasipoisson")
did_female_physical_low = glm(noind_formula, data = subset(data, gender == 1 & jqi_physical_environment < median(jqi_physical_environment)), weights = my_wgt, family="quasipoisson")
did_male_physical_high = glm(noind_formula, data = subset(data, gender == 0 & jqi_physical_environment >= median(jqi_physical_environment)), weights = my_wgt, family="quasipoisson")
did_male_physical_low = glm(noind_formula, data = subset(data, gender == 0 & jqi_physical_environment < median(jqi_physical_environment)), weights = my_wgt, family="quasipoisson")

# DID female/male jqi_social_environment above/below mean
did_female_social_high = glm(noind_formula, data = subset(data, gender == 1 & jqi_social_environment >= median(jqi_social_environment)), weights = my_wgt, family="quasipoisson")
did_female_social_low = glm(noind_formula, data = subset(data, gender == 1 & jqi_social_environment < median(jqi_social_environment)), weights = my_wgt, family="quasipoisson")
did_male_social_high = glm(noind_formula, data = subset(data, gender == 0 & jqi_social_environment >= median(jqi_social_environment)), weights = my_wgt, family="quasipoisson")
did_male_social_low = glm(noind_formula, data = subset(data, gender == 0 & jqi_social_environment < median(jqi_social_environment)), weights = my_wgt, family="quasipoisson")

# DID female/male jqi_working_time_quality above/below mean
did_female_time_high = glm(noind_formula, data = subset(data, gender == 1 & jqi_working_time_quality >= median(jqi_working_time_quality)), weights = my_wgt, family="quasipoisson")
did_female_time_low = glm(noind_formula, data = subset(data, gender == 1 & jqi_working_time_quality < median(jqi_working_time_quality)), weights = my_wgt, family="quasipoisson")
did_male_time_high = glm(noind_formula, data = subset(data, gender == 0 & jqi_working_time_quality >= median(jqi_working_time_quality)), weights = my_wgt, family="quasipoisson")
did_male_time_low = glm(noind_formula, data = subset(data, gender == 0 & jqi_working_time_quality < median(jqi_working_time_quality)), weights = my_wgt, family="quasipoisson")

# DID female/male jqi_prospects above/below mean
did_female_prospects_high = glm(noind_formula, data = subset(data, gender == 1 & jqi_prospects >= median(jqi_prospects)), weights = my_wgt, family="quasipoisson")
did_female_prospects_low = glm(noind_formula, data = subset(data, gender == 1 & jqi_prospects < median(jqi_prospects)), weights = my_wgt, family="quasipoisson")
did_male_prospects_high = glm(noind_formula, data = subset(data, gender == 0 & jqi_prospects >= median(jqi_prospects)), weights = my_wgt, family="quasipoisson")
did_male_prospects_low = glm(noind_formula, data = subset(data, gender == 0 & jqi_prospects < median(jqi_prospects)), weights = my_wgt, family="quasipoisson")

# DID female/male jqi_intensity above/below mean
did_female_intensity_high = glm(noind_formula, data = subset(data, gender == 1 & jqi_intensity >= median(jqi_intensity)), weights = my_wgt, family="quasipoisson")
did_female_intensity_low = glm(noind_formula, data = subset(data, gender == 1 & jqi_intensity < median(jqi_intensity)), weights = my_wgt, family="quasipoisson")
did_male_intensity_high = glm(noind_formula, data = subset(data, gender == 0 & jqi_intensity >= median(jqi_intensity)), weights = my_wgt, family="quasipoisson")
did_male_intensity_low = glm(noind_formula, data = subset(data, gender == 0 & jqi_intensity < median(jqi_intensity)), weights = my_wgt, family="quasipoisson")
```

```{r}
summary(did_female_intensity_low, robust = "vcovHC")
```

```{r}
clustered_se <- vcovHC(did_female, type = "HC1", cluster = "cell1")
robust_se <- sqrt(diag(clustered_se))

coeftest(did_female, vcov. = clustered_se)
```


### Descriptive statistics

```{r}
# correlations
cor_matrix <- cor(data[, c("age","gender","nb_children","nb_grandchildren","partnerinhh","yrseducation","thinc","investment","life_insurance","sphus","chronic",
                           "eurod","work_horizon", "work_horizon_change", "jqi_skills_discretion_pure", "jqi_physical_environment_pure",
                           "jqi_social_environment_pure","jqi_working_time_quality_pure", "jqi_prospects_pure", "jqi_intensity_pure")])

corrplot(cor_matrix, method = "color", col = colorRampPalette(c("lightgreen", "white", "salmon"))(20),tl.cex = 0.7)
```

```{r}
# correlations
cor_matrix <- cor(data[, c("jqi_skills_discretion", "jqi_physical_environment",
                           "jqi_social_environment","jqi_working_time_quality", "jqi_prospects", "jqi_intensity")])

corrplot(cor_matrix, method = "number", col = colorRampPalette(c("lightgreen", "white", "salmon"))(20),tl.cex = 0.7)
```


```{r}
# demographics
data_summary <- data %>% dplyr::select(gender, age, nb_children, nb_grandchildren, partnerinhh, yrseducation, thinc, investment, life_insurance)
knitr::kable(psych::describe(data_summary, skew = FALSE), digits = c(1,4,2,2,1,1,1,3))
```

```{r}
# work
data_summary <- data %>% dplyr::select(yrscontribution, retirement_age, work_horizon, work_horizon_change, jqi_skills_discretion_pure, jqi_physical_environment_pure, jqi_social_environment_pure, jqi_working_time_quality_pure, jqi_prospects_pure, jqi_intensity_pure, jqi_sum_pure)
knitr::kable(psych::describe(data_summary, skew = FALSE), digits = c(1,4,2,2,1,1,1,3))
```

```{r}
# health
data_summary <- data %>% dplyr::select(sphus, sphus2, chronic, chronic2, eurod, eurodcat, affective_suffering, motivation_lack)
knitr::kable(psych::describe(data_summary, skew = FALSE), digits = c(1,4,2,2,1,1,1,3))
```

### Cross table and different tests
```{r}
crosstable(subset(data, time == 0), c(eurod, eurodcat), by=treated, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```


```{r}
# demographics
crosstable(data, c(gender, age, nb_children, nb_grandchildren, partnerinhh, yrseducation, thinc, investment, life_insurance), by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```

```{r}
# work
crosstable(data, c(yrscontribution, retirement_age, work_horizon, work_horizon_change, work_horizon_change_bin0, work_horizon_change_bin1, work_horizon_change_cat, job_status), by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```


```{r}
# work quality
crosstable(data, c(jqi_skills_discretion_pure, jqi_physical_environment_pure, jqi_social_environment_pure, jqi_working_time_quality_pure, jqi_prospects_pure, jqi_intensity_pure, jqi_sum_pure), by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```


```{r}
# health
crosstable(data, c(sphus, sphus2, chronic, chronic2), by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```


```{r}
crosstable(data, did, by=eurodcat, test=TRUE) %>%
  as_flextable(fontsizes = list(body = 8, subheaders = 8, header = 8),)
```


`
